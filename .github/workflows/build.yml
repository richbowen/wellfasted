name: ğŸ›  WellFasted CI/CD - Android Build & Release

on:
  push:
    branches: [master, main]
    tags: ["v*.*.*"]
  pull_request:
    branches: [master, main]

permissions:
  contents: write # allow creating/updating Releases & uploading assets
  actions: read # allow pulling marketplace actions

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CODE QUALITY & TESTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze_and_test:
    runs-on: ubuntu-latest
    name: ğŸ” Code Quality & Tests

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Cache pub deps
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: ğŸ¦‹ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: ğŸ“¥ Get dependencies
        run: flutter pub get

      - name: ğŸ” Analyze code
        run: flutter analyze --fatal-infos

      - name: ğŸ§ª Run tests
        run: flutter test --coverage || echo "Tests failed but continuing build"

      - name: ğŸ“Š Upload coverage reports
        if: github.event_name == 'push' && success()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ANDROID BUILD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build_android:
    needs: analyze_and_test
    runs-on: ubuntu-latest
    name: ğŸ¤– Build Android

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Cache pub deps
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: ğŸš€ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: â˜•ï¸ Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: ğŸ¦‹ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: ğŸ“¥ Get dependencies
        run: flutter pub get

      - name: ğŸ”§ Generate build files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs || echo "No build runner needed"

      - name: ğŸ—ï¸ Build APK (Debug)
        if: github.event_name == 'pull_request'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: flutter build apk --debug --dart-define=GEMINI_API_KEY=$GEMINI_API_KEY --dart-define=ENV=development

      - name: ğŸ—ï¸ Build APKs (Release - Split per ABI)
        if: github.event_name == 'push'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: flutter build apk --release --split-per-abi --dart-define=GEMINI_API_KEY=$GEMINI_API_KEY --dart-define=ENV=production

      - name: ğŸ—ï¸ Build Universal APK (Release)
        if: github.event_name == 'push'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: flutter build apk --release --dart-define=GEMINI_API_KEY=$GEMINI_API_KEY --dart-define=ENV=production

      - name: ğŸ“ List build outputs
        run: |
          echo "ğŸ” APK outputs:"
          find build/app/outputs -name "*.apk" -type f || echo "No APKs found"

      - name: ğŸ“¦ Upload Android APK artifacts
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: wellfasted-android-apks
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      - name: ğŸ“¦ Upload Debug APK (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: wellfasted-android-debug-apk
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # RELEASE (only on tags)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build_android]
    runs-on: ubuntu-latest
    name: ğŸ·ï¸ Create Release

    steps:
      - name: ğŸ“‚ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          name: wellfasted-android-apks
          path: release-artifacts/apks

      - name: ğŸ“¦ Prepare release assets
        run: |
          mkdir -p release-assets

          # Copy APKs with descriptive names
          for apk in release-artifacts/apks/*.apk; do
            if [[ -f "$apk" ]]; then
              filename=$(basename "$apk")
              # Add version tag to filename
              new_name="WellFasted-${{ github.ref_name }}-${filename}"
              cp "$apk" "release-assets/${new_name}"
            fi
          done

          # List all files for verification
          echo "ğŸ“‹ Release assets prepared:"
          ls -la release-assets/

      - name: ğŸ·ï¸ Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: WellFasted ${{ github.ref_name }}
          body: |
            ## ğŸ½ï¸ WellFasted Release ${{ github.ref_name }}

            **Intermittent Fasting Tracker with AI-powered meal recommendations**

            ### ğŸ“± Downloads
            - **APK Files**: For direct installation on Android devices
            - **App Bundle (AAB)**: For Google Play Store deployment

            ### âœ¨ Features
            - â±ï¸ Customizable fasting timers
            - ğŸ¤– AI-powered meal recommendations via Gemini
            - ğŸ“Š Fasting history tracking
            - ğŸ”” Smart notifications
            - ğŸ¨ Beautiful, modern UI

            ### ğŸ“‹ Installation
            1. Download the appropriate APK for your device architecture
            2. Enable "Install from unknown sources" in Android settings
            3. Install the APK file

            ---

            **Built with Flutter** ğŸ¦‹ | **Powered by Gemini AI** ğŸ¤–
          artifacts: release-assets/*
          generateReleaseNotes: true
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD SUMMARY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build_summary:
    if: always()
    needs: [analyze_and_test, build_android]
    runs-on: ubuntu-latest
    name: ğŸ“‹ Build Summary

    steps:
      - name: ğŸ“Š Print build summary
        run: |
          echo "## ğŸ—ï¸ WellFasted Build Summary"
          echo "- **Code Quality**: ${{ needs.analyze_and_test.result }}"
          echo "- **Android Build**: ${{ needs.build_android.result }}"
          echo "- **Trigger**: ${{ github.event_name }}"
          echo "- **Branch/Tag**: ${{ github.ref }}"
          echo "- **Commit**: ${{ github.sha }}"
